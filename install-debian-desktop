#!/bin/bash -ex

# Check whether ``sudo`` is installed
which sudo || \
    ( su -c "apt-get install -y sudo && usermod -aG sudo $(whoami)" &&\
    echo "Logout and re-execute ./install" )

# Register repositories
sudo sh -exc '
    apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
    gpg --keyserver pgpkeys.mit.edu --recv-key 3EE67F3D0FF405B2
    gpg --keyserver pgpkeys.mit.edu --recv-key 5C808C2B65558117
    gpg --keyserver pgpkeys.mit.edu --recv-key 07DC563D1F41B907
    gpg --keyserver keyserver.ubuntu.com --recv-key 0F164EEB
    gpg -a --export 3EE67F3D0FF405B2 | sudo apt-key add -
    gpg -a --export 5C808C2B65558117 | sudo apt-key add -
    gpg -a --export 07DC563D1F41B907 | sudo apt-key add -
    gpg -a --export 0F164EEB         | sudo apt-key add -
    apt-get install -y software-properties-common
    dpkg -l gyazo >/dev/null 2>&1 || curl -s https://packagecloud.io/install/repositories/gyazo/gyazo-for-linux/script.deb.sh | sudo bash
'

cat <<EOL | sudo tee /etc/apt/sources.list.d/multimedia.list
# Auto-generated
# Debian Mutimedia
deb http://ftp.yzu.edu.tw/Linux/debian-multimedia/ jessie main non-free
deb-src http://ftp.yzu.edu.tw/Linux/debian-multimedia/ jessie main non-free
EOL

cat <<EOL | sudo tee /etc/apt/sources.list.d/contrib.list
# Auto-generated
# Debian 8 "Jessie"
deb http://httpredir.debian.org/debian/ jessie main contrib
EOL

cat <<EOL | sudo tee /etc/apt/sources.list.d/docker.list
# Auto-generated
# Docker (Debian 8 "Jessie")
deb https://apt.dockerproject.org/repo debian-jessie main
EOL

cat <<EOL | sudo tee /etc/apt/sources.list.d/linux-mint.list
# Auto-generated
# Linux mint
deb http://packages.linuxmint.com debian import
EOL

cat <<EOL | sudo tee /etc/apt/sources.list.d/numix.list
# Auto-generated
# Numix
deb http://ppa.launchpad.net/numix/ppa/ubuntu trusty main
deb-src http://ppa.launchpad.net/numix/ppa/ubuntu trusty main
EOL

# Support HTTPS
sudo apt-get install -y apt-transport-https

# Update
sudo apt-get update

# Install packages
sudo apt-get install -y \
    git vim vim-nox byobu fonts-vlgothic ibus-mozc \
    linux-headers-$(uname -r|sed 's,[^-]*-[^-]*-,,') virtualbox vagrant \
    xsel python-pip python-dev keepass2 xdotool libpq5 libpq-dev w3m w3m-img \
    postgresql-client libnotify-bin gnome-screensaver nkf html-xml-utils \
    docker-engine firefox kpcli expect zip gauche \
    numix-gtk-theme numix-folders numix-icon-theme rlwrap \
    winetricks wine64-tools cabextract redis-tools gyazo libcanberra-gtk-module \
    tree libncurses5-dev socat devscripts

pip='/usr/local/bin/pip2'
[ -f "${pip}" ] || exit 1

sudo ${pip} install -U mercurial ansible virtualenvwrapper docker-compose

# Download dotfiles
[ -d "$HOME/dotfiles" ] || \
    git clone https://github.com/pjxiao/dotfiles "$HOME/dotfiles"

# Configure dotfiles
grep -q '# Load dotfiles' $HOME/.bashrc || \
    echo -e '\n# Load dotfiles\nsource ~/dotfiles/.bashrc' >> $HOME/.bashrc
grep -q '" Load dotfiles' $HOME/.vimrc || \
    echo -e '\n" Load dotfiles\nexe '"'source'"' $HOME . "/dotfiles/.vimrc"' >> $HOME/.vimrc
ln -s ${HOME}/dotfiles/.inputrc ${HOME}/.inputrc || true
